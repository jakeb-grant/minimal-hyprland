#!/bin/bash
#
# Minimal Hyprland Configurator
# Beautiful manual Arch Linux installation with Hyprland
#

set -eEuo pipefail

# Colors and styling
export GUM_INPUT_CURSOR_FOREGROUND="212"
export GUM_INPUT_PROMPT_FOREGROUND="6"
export GUM_CHOOSE_CURSOR_FOREGROUND="212"
export GUM_CONFIRM_SELECTED_BACKGROUND="2"
export GUM_SPIN_SPINNER="dot"
export GUM_SPIN_SPINNER_FOREGROUND="212"

# Helper functions for beautiful output
step() {
  gum style --foreground 212 --bold "â†’ $1"
}

success() {
  gum style --foreground 2 "âœ“ $1"
}

error() {
  gum style --foreground 1 --bold "âœ— $1"
}

info() {
  gum style --foreground 6 "$1"
}

run_with_spinner() {
  local message="$1"
  shift
  gum spin --title "$message" -- "$@"
}

clear

# ASCII Art Logo
gum style \
  --foreground 212 --bold --align center \
  '
 â•¦ â•¦â”¬ â”¬â”Œâ”€â”â”¬â”€â”â”¬  â”Œâ”€â”â”Œâ”â”Œâ”Œâ”¬â”
 â• â•â•£â””â”¬â”˜â”œâ”€â”˜â”œâ”¬â”˜â”‚  â”œâ”€â”¤â”‚â”‚â”‚ â”‚â”‚
 â•© â•© â”´ â”´  â”´â””â”€â”´â”€â”˜â”´ â”´â”˜â””â”˜â”€â”´â”˜
'

echo
gum style --foreground 6 --align center "Minimal Hyprland Installer"
gum style --foreground 8 --align center "A beautiful, unopinionated Arch + Hyprland setup"
echo
echo

# Welcome
gum style --foreground 3 "Welcome! This installer will help you set up Arch Linux with Hyprland."
echo
gum style --foreground 8 "We'll ask you a few questions, then install the base system."
gum style --foreground 8 "After that, we'll automatically install and configure Hyprland."
echo
echo

if ! gum confirm "Ready to begin?"; then
  echo "Installation cancelled."
  exit 0
fi

clear

# ============================================================================
# Collect User Information
# ============================================================================

gum style --foreground 212 --bold "Step 1: User Information"
echo

# Full name
USER_FULL_NAME=$(gum input \
  --placeholder "John Doe" \
  --prompt "Your full name: " \
  --width 50)

# Email
USER_EMAIL=$(gum input \
  --placeholder "john@example.com" \
  --prompt "Email address (for git): " \
  --width 50)

# Username (auto-generate from full name)
DEFAULT_USERNAME=$(echo "$USER_FULL_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g')
USERNAME=$(gum input \
  --placeholder "$DEFAULT_USERNAME" \
  --prompt "Username (lowercase): " \
  --value "$DEFAULT_USERNAME" \
  --width 50)

# Hostname
DEFAULT_HOSTNAME="${USERNAME}-hyprland"
HOSTNAME=$(gum input \
  --placeholder "$DEFAULT_HOSTNAME" \
  --prompt "Hostname: " \
  --value "$DEFAULT_HOSTNAME" \
  --width 50)

clear

# ============================================================================
# Disk Selection
# ============================================================================

gum style --foreground 212 --bold "Step 2: Disk Configuration"
echo

# List available disks
DISKS=$(lsblk -d -n -o NAME,SIZE,TYPE | grep disk | awk '{print "/dev/" $1 " (" $2 ")"}')

if [ -z "$DISKS" ]; then
  error "No disks found! Cannot proceed."
  exit 1
fi

# Let user choose disk
SELECTED_DISK=$(echo "$DISKS" | gum choose --header "Select installation disk:")
DISK_PATH=$(echo "$SELECTED_DISK" | awk '{print $1}')

echo
gum style --foreground 3 "Selected: $DISK_PATH"
gum style --foreground 1 --bold "âš  WARNING: All data on $DISK_PATH will be erased!"
echo

if ! gum confirm "Continue with $DISK_PATH?"; then
  echo "Installation cancelled."
  exit 0
fi

# Encryption
echo
USE_ENCRYPTION=$(gum choose "Enable disk encryption (recommended)" "No encryption" --header "Disk encryption:")

if [ "$USE_ENCRYPTION" = "Enable disk encryption (recommended)" ]; then
  ENCRYPTION_PASSWORD=$(gum input --password --placeholder "Enter encryption password")
  ENCRYPTION_PASSWORD_CONFIRM=$(gum input --password --placeholder "Confirm encryption password")

  if [ "$ENCRYPTION_PASSWORD" != "$ENCRYPTION_PASSWORD_CONFIRM" ]; then
    error "Passwords do not match! Exiting."
    exit 1
  fi

  USE_ENCRYPTION_FLAG="yes"
else
  USE_ENCRYPTION_FLAG="no"
fi

clear

# ============================================================================
# System Configuration
# ============================================================================

gum style --foreground 212 --bold "Step 3: System Settings"
echo

# Timezone (auto-detect or let user choose)
DETECTED_TIMEZONE=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "America/New_York")
TIMEZONE=$(gum input \
  --placeholder "$DETECTED_TIMEZONE" \
  --prompt "Timezone: " \
  --value "$DETECTED_TIMEZONE" \
  --width 50)

# Locale
LOCALE=$(gum choose "en_US.UTF-8" "en_GB.UTF-8" "de_DE.UTF-8" "fr_FR.UTF-8" "es_ES.UTF-8" "Other" \
  --header "Select locale:")

if [ "$LOCALE" = "Other" ]; then
  LOCALE=$(gum input --placeholder "en_US.UTF-8" --prompt "Locale: ")
fi

# Keyboard layout
KEYBOARD=$(gum choose "us" "uk" "de" "fr" "es" "Other" \
  --header "Keyboard layout:")

if [ "$KEYBOARD" = "Other" ]; then
  KEYBOARD=$(gum input --placeholder "us" --prompt "Keyboard layout: ")
fi

# User password
echo
gum style --foreground 6 "User Account Password"
USER_PASSWORD=$(gum input --password --placeholder "Enter password for $USERNAME")
USER_PASSWORD_CONFIRM=$(gum input --password --placeholder "Confirm password")

if [ "$USER_PASSWORD" != "$USER_PASSWORD_CONFIRM" ]; then
  error "Passwords do not match! Exiting."
  exit 1
fi

clear

# ============================================================================
# Confirmation
# ============================================================================

gum style --foreground 212 --bold "Installation Summary"
echo

gum style --foreground 6 "User Information:"
echo "  Name: $USER_FULL_NAME"
echo "  Email: $USER_EMAIL"
echo "  Username: $USERNAME"
echo "  Hostname: $HOSTNAME"
echo

gum style --foreground 6 "System Configuration:"
echo "  Disk: $DISK_PATH"
echo "  Encryption: $USE_ENCRYPTION_FLAG"
echo "  Timezone: $TIMEZONE"
echo "  Locale: $LOCALE"
echo "  Keyboard: $KEYBOARD"
echo

if ! gum confirm "Proceed with installation?"; then
  echo "Installation cancelled."
  exit 0
fi

clear

# ============================================================================
# Installation Phase
# ============================================================================

gum style --foreground 212 --bold --align center "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                       â•‘
â•‘     Beginning Installation...         â•‘
â•‘                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"
echo
sleep 1

# Detect boot mode
if [ -d /sys/firmware/efi ]; then
  BOOT_MODE="UEFI"
  info "Detected boot mode: UEFI"
else
  BOOT_MODE="BIOS"
  info "Detected boot mode: BIOS (Legacy)"
fi
echo

# ============================================================================
# Step 1: Partition Disk
# ============================================================================

step "Step 1/7: Partitioning disk $DISK_PATH"
echo

# Wipe existing partition table
run_with_spinner "Wiping disk..." \
  wipefs -af "$DISK_PATH"

run_with_spinner "Creating GPT partition table..." \
  sgdisk -o "$DISK_PATH"

# Create ESP partition (1GB)
run_with_spinner "Creating EFI system partition (1GB)..." \
  sgdisk -n 1:0:+1G -t 1:ef00 -c 1:"EFI System" "$DISK_PATH"

# Create root partition (rest of disk, minus safety buffer)
run_with_spinner "Creating root partition..." \
  sgdisk -n 2:0:-1G -t 2:8300 -c 2:"Linux root" "$DISK_PATH"

# Inform kernel of partition changes
run_with_spinner "Updating partition table..." \
  partprobe "$DISK_PATH"

sleep 1
success "Disk partitioned successfully"
echo

# Determine partition naming (nvme uses p1, p2; sda uses 1, 2)
if [[ "$DISK_PATH" =~ nvme ]]; then
  PART_PREFIX="${DISK_PATH}p"
else
  PART_PREFIX="${DISK_PATH}"
fi

BOOT_PARTITION="${PART_PREFIX}1"
ROOT_PARTITION="${PART_PREFIX}2"

info "  ESP: $BOOT_PARTITION"
info "  Root: $ROOT_PARTITION"
echo

# ============================================================================
# Step 2: Encrypt Root Partition (if enabled)
# ============================================================================

if [ "$USE_ENCRYPTION_FLAG" = "yes" ]; then
  step "Step 2/7: Setting up disk encryption"
  echo

  # Format LUKS container
  info "Encrypting root partition with LUKS..."
  echo -n "$ENCRYPTION_PASSWORD" | cryptsetup luksFormat --type luks2 "$ROOT_PARTITION" -
  success "LUKS container created"

  # Open encrypted partition
  echo -n "$ENCRYPTION_PASSWORD" | cryptsetup open "$ROOT_PARTITION" cryptroot -
  success "Encrypted partition unlocked"

  ROOT_DEVICE="/dev/mapper/cryptroot"
  echo
else
  step "Step 2/7: Skipping encryption (not enabled)"
  ROOT_DEVICE="$ROOT_PARTITION"
  echo
fi

# ============================================================================
# Step 3: Format Partitions
# ============================================================================

step "Step 3/7: Formatting partitions"
echo

run_with_spinner "Formatting EFI partition as FAT32..." \
  mkfs.fat -F32 -n "BOOT" "$BOOT_PARTITION"

run_with_spinner "Formatting root partition as ext4..." \
  mkfs.ext4 -F -L "ROOT" "$ROOT_DEVICE"

success "Partitions formatted"
echo

# ============================================================================
# Step 4: Mount Partitions
# ============================================================================

step "Step 4/7: Mounting partitions"
echo

run_with_spinner "Mounting root partition..." \
  mount "$ROOT_DEVICE" /mnt

run_with_spinner "Creating /mnt/boot directory..." \
  mkdir -p /mnt/boot

run_with_spinner "Mounting boot partition..." \
  mount "$BOOT_PARTITION" /mnt/boot

success "Partitions mounted"
echo

# ============================================================================
# Step 5: Install Base System + Packages
# ============================================================================

step "Step 5/7: Installing packages (this will take a while)"
echo

# Read package list
PACKAGE_FILE="/etc/minimal-hyprland/minimal-base.packages"
if [ ! -f "$PACKAGE_FILE" ]; then
  error "Package list not found: $PACKAGE_FILE"
  exit 1
fi

PACKAGES=$(grep -v '^#' "$PACKAGE_FILE" | grep -v '^$' | tr '\n' ' ')

info "Installing base system and all minimal-hyprland packages..."
echo

# Run pacstrap with all packages
if ! gum spin --title "Running pacstrap (this may take 5-15 minutes)..." -- \
  pacstrap -K /mnt base linux linux-firmware $PACKAGES; then
  error "pacstrap failed!"
  exit 1
fi

success "All packages installed successfully"
echo

# ============================================================================
# Step 6: Generate fstab
# ============================================================================

step "Step 6/7: Generating filesystem table"
echo

run_with_spinner "Generating /etc/fstab..." \
  bash -c "genfstab -U /mnt >> /mnt/etc/fstab"

success "fstab generated"
echo

# ============================================================================
# Step 7: Configure System (in chroot)
# ============================================================================

step "Step 7/7: Configuring system"
echo

info "Entering chroot to configure the system..."
echo

# Create configuration script to run inside chroot
cat > /mnt/root/configure-system.sh <<'CHROOT_SCRIPT'
#!/bin/bash
set -eEuo pipefail

# These will be replaced by actual values
TIMEZONE="__TIMEZONE__"
LOCALE="__LOCALE__"
KEYBOARD="__KEYBOARD__"
HOSTNAME="__HOSTNAME__"
USERNAME="__USERNAME__"
USER_PASSWORD="__USER_PASSWORD__"
USER_FULL_NAME="__USER_FULL_NAME__"
USER_EMAIL="__USER_EMAIL__"
USE_ENCRYPTION="__USE_ENCRYPTION__"
ROOT_PARTITION="__ROOT_PARTITION__"
BOOT_MODE="__BOOT_MODE__"
DISK_PATH="__DISK_PATH__"

echo "â†’ Setting timezone to $TIMEZONE..."
ln -sf "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
hwclock --systohc

echo "â†’ Configuring locale ($LOCALE)..."
echo "$LOCALE UTF-8" >> /etc/locale.gen
locale-gen
echo "LANG=$LOCALE" > /etc/locale.conf

echo "â†’ Setting keyboard layout ($KEYBOARD)..."
echo "KEYMAP=$KEYBOARD" > /etc/vconsole.conf

echo "â†’ Configuring SDDM keyboard layout..."
mkdir -p /etc/sddm.conf.d
cat > /etc/sddm.conf.d/keyboard.conf <<SDDM_EOF
[General]
InputMethod=
Numlock=none

[X11]
ServerArguments=-nolisten tcp -layout $KEYBOARD
SDDM_EOF

echo "â†’ Setting hostname ($HOSTNAME)..."
echo "$HOSTNAME" > /etc/hostname

echo "â†’ Configuring hosts file..."
cat > /etc/hosts <<EOF
127.0.0.1   localhost
::1         localhost
127.0.1.1   $HOSTNAME.localdomain $HOSTNAME
EOF

echo "â†’ Creating user account ($USERNAME)..."
useradd -m -G wheel,audio,video,storage,power,input -s /bin/bash "$USERNAME"
echo "$USERNAME:$USER_PASSWORD" | chpasswd

echo "â†’ Enabling sudo for wheel group..."
sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers

echo "â†’ Setting root password..."
echo "root:$USER_PASSWORD" | chpasswd

# Configure mkinitcpio for encryption if enabled
if [ "$USE_ENCRYPTION" = "yes" ]; then
  echo "â†’ Configuring initramfs for disk encryption..."
  sed -i 's/^HOOKS=.*/HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block encrypt filesystems fsck)/' /etc/mkinitcpio.conf
  mkinitcpio -P
fi

# Install and configure bootloader
echo "â†’ Installing GRUB bootloader..."
if [ "$BOOT_MODE" = "UEFI" ]; then
  grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --recheck
else
  grub-install --target=i386-pc "$DISK_PATH" --recheck
fi

# Configure GRUB for encryption
if [ "$USE_ENCRYPTION" = "yes" ]; then
  echo "â†’ Configuring GRUB for encrypted root..."
  ROOT_UUID=$(blkid -s UUID -o value "$ROOT_PARTITION")
  sed -i "s|^GRUB_CMDLINE_LINUX=.*|GRUB_CMDLINE_LINUX=\"cryptdevice=UUID=${ROOT_UUID}:cryptroot root=/dev/mapper/cryptroot\"|" /etc/default/grub
fi

echo "â†’ Generating GRUB configuration..."
grub-mkconfig -o /boot/grub/grub.cfg

echo "â†’ Enabling NetworkManager..."
systemctl enable NetworkManager

echo "âœ“ System configuration complete!"
CHROOT_SCRIPT

# Replace placeholders with actual values
sed -i "s|__TIMEZONE__|$TIMEZONE|g" /mnt/root/configure-system.sh
sed -i "s|__LOCALE__|$LOCALE|g" /mnt/root/configure-system.sh
sed -i "s|__KEYBOARD__|$KEYBOARD|g" /mnt/root/configure-system.sh
sed -i "s|__HOSTNAME__|$HOSTNAME|g" /mnt/root/configure-system.sh
sed -i "s|__USERNAME__|$USERNAME|g" /mnt/root/configure-system.sh
sed -i "s|__USER_PASSWORD__|$USER_PASSWORD|g" /mnt/root/configure-system.sh
sed -i "s|__USER_FULL_NAME__|$USER_FULL_NAME|g" /mnt/root/configure-system.sh
sed -i "s|__USER_EMAIL__|$USER_EMAIL|g" /mnt/root/configure-system.sh
sed -i "s|__USE_ENCRYPTION__|$USE_ENCRYPTION_FLAG|g" /mnt/root/configure-system.sh
sed -i "s|__ROOT_PARTITION__|$ROOT_PARTITION|g" /mnt/root/configure-system.sh
sed -i "s|__BOOT_MODE__|$BOOT_MODE|g" /mnt/root/configure-system.sh
sed -i "s|__DISK_PATH__|$DISK_PATH|g" /mnt/root/configure-system.sh

chmod +x /mnt/root/configure-system.sh

# Run configuration script in chroot
if ! arch-chroot /mnt /root/configure-system.sh; then
  error "System configuration failed!"
  exit 1
fi

rm /mnt/root/configure-system.sh

success "System configured successfully"
echo

# ============================================================================
# Install Minimal Hyprland
# ============================================================================

clear
gum style --foreground 212 --bold "Installing Minimal Hyprland..."
echo

MINIMAL_HYPRLAND_REPO="${MINIMAL_HYPRLAND_REPO:-jakeb-grant/minimal-hyprland}"
MINIMAL_HYPRLAND_BRANCH="${MINIMAL_HYPRLAND_BRANCH:-main}"

info "Repository: https://github.com/$MINIMAL_HYPRLAND_REPO"
info "Branch: $MINIMAL_HYPRLAND_BRANCH"
echo

# Create Hyprland installation script
cat > /mnt/root/install-hyprland.sh <<HYPRLAND_SCRIPT
#!/bin/bash
set -eEuo pipefail

USERNAME="$USERNAME"
USER_FULL_NAME="$USER_FULL_NAME"
USER_EMAIL="$USER_EMAIL"
KEYBOARD="$KEYBOARD"
REPO="$MINIMAL_HYPRLAND_REPO"
BRANCH="$MINIMAL_HYPRLAND_BRANCH"

USER_HOME="/home/\$USERNAME"

echo "â†’ Cloning minimal-hyprland repository..."
su - \$USERNAME -c "git clone https://github.com/\$REPO.git \$USER_HOME/.local/share/minimal-hyprland"

if [ "$MINIMAL_HYPRLAND_BRANCH" != "main" ]; then
  echo "â†’ Checking out branch: \$BRANCH"
  su - \$USERNAME -c "cd \$USER_HOME/.local/share/minimal-hyprland && git checkout \$BRANCH"
fi

echo "â†’ Setting up git configuration..."
export MINIMAL_HYPRLAND_USER_NAME="\$USER_FULL_NAME"
export MINIMAL_HYPRLAND_USER_EMAIL="\$USER_EMAIL"

echo "â†’ Running minimal-hyprland installer..."
# Temporarily grant passwordless sudo
echo "\$USERNAME ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/installer
chmod 440 /etc/sudoers.d/installer

su - \$USERNAME -c "source \$USER_HOME/.local/share/minimal-hyprland/install.sh"

# Remove temporary passwordless sudo
rm -f /etc/sudoers.d/installer

echo "â†’ Configuring Hyprland keyboard layout..."
cat > "\$USER_HOME/.config/hypr/input.conf" <<HYPR_EOF
# User Input Overrides
# Keyboard layout set during installation
input {
    kb_layout = \$KEYBOARD
}
HYPR_EOF
chown \$USERNAME:\$USERNAME "\$USER_HOME/.config/hypr/input.conf"

echo "âœ“ Minimal Hyprland installation complete!"
HYPRLAND_SCRIPT

chmod +x /mnt/root/install-hyprland.sh

# Run Hyprland installer in chroot
if ! arch-chroot /mnt /root/install-hyprland.sh; then
  error "Minimal Hyprland installation failed!"
  exit 1
fi

rm /mnt/root/install-hyprland.sh

success "Minimal Hyprland installed successfully"
echo

# ============================================================================
# Cleanup and Unmount
# ============================================================================

info "Unmounting partitions..."
umount -R /mnt || true

if [ "$USE_ENCRYPTION_FLAG" = "yes" ]; then
  info "Closing encrypted partition..."
  cryptsetup close cryptroot || true
fi

# ============================================================================
# Installation Complete
# ============================================================================

clear
gum style --foreground 2 --bold --align center "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                       â•‘
â•‘  Installation Complete! ðŸŽ‰           â•‘
â•‘                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

echo
gum style --foreground 6 "Your Minimal Hyprland system is ready!"
echo

gum style --foreground 3 "Next steps:"
echo "  1. Remove the installation media"
echo "  2. Reboot into your new system"
if [ "$USE_ENCRYPTION_FLAG" = "yes" ]; then
  echo "  3. Enter your encryption password at boot"
  echo "  4. Login with your credentials"
  echo "  5. Hyprland will start automatically"
else
  echo "  3. Login with your credentials"
  echo "  4. Hyprland will start automatically"
fi
echo

gum style --foreground 8 "Essential keybindings:"
echo "  SUPER + SPACE    â†’ Application launcher"
echo "  SUPER + RETURN   â†’ Terminal"
echo "  SUPER + E        â†’ File manager"
echo "  SUPER + W        â†’ Close window"
echo

if gum confirm "Reboot now?"; then
  reboot
else
  echo
  info "Type 'reboot' when you're ready to restart."
fi
